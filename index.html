<!DOCTYPE html>
<meta charset="utf-8">
<style>
	body {
		font: 10px sans-serif;
        margin: 0;
        padding: 0;
	}

    #main {
        width: 95vw;
        height: 95vh;
        border: 1px solid black;
        overflow: scroll;
        margin-left: auto;
        margin-right: auto;
    }

    #control {
        background: #CCCCCC;
    }

    svg {
        margin: 0;
        padding: 0;
    }

    rect {
        fill: none;
        stroke: red;
    }

    text {
        stroke: black;
    }
</style>
<body>

<script src="d3.js" charset="utf-8"></script>

<script>
    var xmldoc = null;
    var svg = null;
    var pageNumOffset = 0;
    var curPage = 0;
    var pages = null;
    var fontspecs = {};  // are global for all pages

    function displayPage(p) {
        var w = p.attributes['width'].value;
        var h = p.attributes['height'].value;

        function textStyle(textNode, prop) {
            var spec = fontspecs[textNode.attributes['font'].value];
            return spec[prop];
        }

        if (svg != null) {
            svg.remove();
        }

        svg = d3.select("#main").append("svg")
                .attr("width", w)
                .attr("height", h);

        var textNodes = p.getElementsByTagName('text');

        var textGroups = svg.selectAll('.text')
                .data(textNodes).enter()
                .append('g')
                .attr('class', 'text')
                .attr('transform', function (d) {
                    var x = d.attributes['left'].value;
                    var y = d.attributes['top'].value;
                    return 'translate(' + x + ', ' + y + ')';
                });

        var textRects = textGroups.append('rect')
                .attr('width', function (d) { return d.attributes['width'].value; })
                .attr('height', function (d) { return d.attributes['height'].value; });
        var textInRects = textGroups.append('text')
                .attr('dy', function (d) { return d.attributes['height'].value / 1.4; })
                .style('font-size', function (d) { return textStyle(d, 'size') })
                .style('font-family', function (d) { return textStyle(d, 'family') })
                .style('font-weight', function (d) {
                    if (d.childNodes[0].innerHTML) {
                        return 'bold';
                    } else {
                        return 'normal';
                    }
                })
                .text(function (d) {
                    if (d.childNodes[0].innerHTML) {
                        return d.childNodes[0].innerHTML;
                    } else {
                        return d.childNodes[0].nodeValue;
                    }
                });
    }

    function loadXMLFile() {
        var xmlFile = document.getElementById('xmlfile').value;

        if (xmlFile.match(/^\W/) || xmlFile.match(/^(http|https|file):/)) {
            return;
        }

        console.log("loading XML file '" + xmlFile + "'");
        d3.xml(xmlFile, 'application/xml', function (d) {
            xmldoc = d;

            pages = xmldoc.getElementsByTagName('page');

            if (pages.length <= 0) return;

            loadFontSpecs(pages);

            pageNumOffset = parseInt(pages[0].attributes['number'].value);
            document.getElementById('pagenum').disabled = false;
            document.getElementById('pagemax').innerHTML = pageNumOffset + pages.length - 1;

            setPage(0);
        });
    }

    function loadFontSpecs(pages) {
        for (var p_i = 0; p_i < pages.length; p_i++) {
            var p = pages[p_i];
            var fontspecElems = p.getElementsByTagName('fontspec');
            for (var i = 0; i < fontspecElems.length; i++) {
                var spec = fontspecElems[i].attributes;
                fontspecs[spec.id.value] = {
                    'size': spec.size.value,
                    'family': spec.family.value
                }
            }

        }
    }

    function setPage(num) {
        if (num == null) {
            num = parseInt(document.getElementById('pagenum').value) - 1;

            if (num < 0 || num >= pages.length) {
                return;
            }
        } else {
            document.getElementById('pagenum').value = pageNumOffset + num;
        }

        curPage = num;
        displayPage(pages[num]);
    }

    function changePage(by) {
        var toPage = curPage + by;
        if (toPage >= 0 && toPage < pages.length) {
            setPage(toPage);
        }
    }
</script>

<div id="control">
    <fieldset>
        <label for="xmlfile">XML File:</label>
        <input id="xmlfile" name="xmlfile" type="text" required autofocus>
        <input type="submit" value="Load" onclick="loadXMLFile()" style="margin-right: 5em">

        <label for="pagenum">Page:</label>
        <button onclick="changePage(-1)">&larr;</button>
        <input id="pagenum" name="pagenum" type="number" onchange="setPage()" size="4" style="width: 40px" disabled> / <span id="pagemax">?</span>
        <button onclick="changePage(+1)">&rarr;</button>
    </fieldset>
</div>

<div id="main">

</div>

</body>
